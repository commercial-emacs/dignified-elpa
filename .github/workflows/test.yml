name: Test Action
on:
  pull_request:
    paths-ignore:
    - '**.rst'
    - '**.txt'
    - '**.texi'
    - '**.md'
  push:
    paths-ignore:
    - '**.txt'
    - '**.rst'
    - '**.texi'
    - '**.md'
    branches-ignore:
    - 'master'
    - 'main'

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        emacs-version: ['29.4', '30.2', 'snapshot', 'snapshot-commercial']

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - uses: dickmao/setup-emacs@dignified-elpa
        with:
          version: ${{ matrix.emacs-version }}
          repository: dickmao/nix-emacs-ci
          branch: dignified-elpa

      - name: Create test package
        run: |
          cat > test-package.el << 'EOF'
          ;;; test-package.el --- Test package

          ;;; Code:

          (defun test-function ()
            "A simple test function."
            (+ 1 2 3))

          (provide 'test-package)
          ;;; test-package.el ends here
          EOF

      - name: Build action
        run: |
          npm install
          npm run build

      - name: Test action
        uses: ./
        with:
          package-file: 'test-package.el'

      - name: Verify compilation
        run: |
          if [ -z "$(find . -name '*.elc' 2>/dev/null)" ]; then
            echo "No .elc files found"
            exit 1
          fi
          echo "âœ“ Byte compilation successful"
